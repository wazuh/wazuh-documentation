.. Copyright (C) 2019 Wazuh, Inc.

.. _use-registration-service:

Using the registration service
==============================

The ``ossec-authd`` daemon allows to register agents automatically.

- The manager uses :ref:`ossec-authd` to start the registration service.
- On the agent, :ref:`agent-auth` is used to connect to the registration service.

Launching the daemon on the manager with default options would allow any agent to register itself, and then connect to it. The secure methods provide some mechanisms to authorize the connections.

+------------+--------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------+
| Type       | Method                                                                                     | Description                                                                                                                 |
+============+============================================================================================+=============================================================================================================================+
| Not secure | :ref:`simple-registration-service`                                                         | The easiest method. There is no authentication or host verification.                                                        |
+------------+--------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------+
| Secure     | :ref:`password-authorization-registration-service`                                         | Allows agents to authenticate via a shared password. This method is easy but does not perform host validation.              |
|            +--------------------------------+-----------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------+
|            | `Host verification using SSL`_ | `Manager verification using SSL`_                         | The manager's certificate is signed by a CA that agents use to validate the server. This may include host checking.         |
|            |                                +---------------------------------+-------------------------+-----------------------------------------------------------------------------------------------------------------------------+
|            |                                | `Agent verification using SSL`_ | With host validation    | The same as above, but the manager verifies the agent's certificate and address. There should be one certificate per agent. |
|            |                                |                                 +-------------------------+-----------------------------------------------------------------------------------------------------------------------------+
|            |                                |                                 | Without host validation | The manager validates the agent by CA but not the host address. This method allows the use of a shared agent certificate.   |
+------------+--------------------------------+---------------------------------+-------------------------+-----------------------------------------------------------------------------------------------------------------------------+

.. note::
  The secure methods can be combined for a stronger security during the registration process.

Prerequisites
-------------

The registration service requires an SSL certificate on the manager in order to work. This certificate will be automatically generated by the package during the installation if the ``openssl`` package is installed. This certificate is stored in ``/var/ossec/etc/sslmanager.cert``.

If you already have a certificate, you can use them just by copying them into the same path:

.. code-block:: console

  # cp <ssl_cert> /var/ossec/etc/sslmanager.cert
  # cp <ssl_key> /var/ossec/etc/sslmanager.key

Otherwise, you can create a self-signed certificate using the following command:

.. code-block:: console

  # openssl req -x509 -batch -nodes -days 365 -newkey rsa:2048 -out /var/ossec/etc/sslmanager.cert -keyout /var/ossec/etc/sslmanager.key

Since version 3.8.0, the registration daemon ``ossec-auth`` is running by default when the installation is complete.

.. warning::
  If the host verification process fails, the connection won't be realized.

Additional configurations
-------------------------

* By default, the registration service adds the agents with their static IP address. If you want to add them with a dynamic IP (like using ``any`` on the ``manage_agents`` tool), you must change the manager's configuration file (``/var/ossec/etc/ossec.conf``):

  .. code-block:: xml

    <auth>
      <use_source_ip>no</use_source_ip>
    </auth>

* Duplicate IPs are not allowed, so an agent won't be added if there is already another agent registered with the same IP. By changing the configuration file, ``ossec-authd`` can be told to **force a registration** if it finds an older agent with the same IP address. This will make the older agent's registration be deleted:

  .. code-block:: xml

    <auth>
      <force_insert>yes</force_insert>
      <force_time>0</force_time>
    </auth>

  The **0** on ``<force-time>`` means the minimum time, in seconds, since the last connection of the old agent (the one to be deleted). In this case, it means to delete the old agent's registration regardless of how recently it has checked in.
