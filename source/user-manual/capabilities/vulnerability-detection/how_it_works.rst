.. Copyright (C) 2021 Wazuh, Inc.
.. meta::
  :description: Vulnerability Detection is one of the Wazuh capabilities. Learn more about how it works and the repositories it uses. 
  
.. vu_how_it_works:

How it works
============

To be able to detect vulnerabilities, now agents are able to natively collect a list of installed applications (:ref:`System inventory <syscollector>`), sending it periodically to the manager (where it is stored in local sqlite databases, one per agent). Also, the manager builds a global vulnerability database, from publicly available CVE repositories, using it later to cross-correlate this information with the agent's applications inventory data.

The global vulnerability database is created automatically, currently pulling data from the following repositories:

- `<https://canonical.com>`_: Used to pull CVEs for Ubuntu Linux distributions.
- `<https://www.redhat.com>`_: Used to pull CVEs for Red Hat and CentOS Linux distributions.
- `<https://www.debian.org>`_: Used to pull CVEs for Debian Linux distributions.
- `<https://security.archlinux.org>`_: Used to pull CVEs for Arch Linux distributions.
- `<https://nvd.nist.gov/>`_: Used to pull CVEs from the National Vulnerability Database.
- `<https://feed.wazuh.com/>`_: Used to pull the MSU feed with CVEs and patches for Microsoft products.

This database can be configured to be updated periodically, ensuring that the solution will check for the very latest CVEs.

Once the global vulnerability database (with the CVEs) is created, the detection process looks for vulnerable packages in the inventory databases (unique per agent). Alerts are generated when a CVE (Common Vulnerabilities and Exposures) affects a package that is known to be installed in one of the monitored hosts. A package is labeled as vulnerable when its version is contained within the affected range of a CVE.
The results are presented as alerts and also stored in a database. So you can check the last scan alerts, or query every single agent's vulnerable software DB.

.. _vuln_det_scan_types:

Scan types
^^^^^^^^^^

The `Vulnerability Detector` module performs a scan when it is enabled generating a vulnerabilities inventory of packages and operating system installed in the managed agents.
It also can run a scan on startup (:ref:`run_on_start <vuln_det_run_on_start>`) and every certain period of time (:ref:`interval <vuln_det_interval>`).
In any of these cases, the packages and the operating system that were already scanned will not be re-scanned, only the new ones will do and alerts are going to be generated.
If the database of vulnerabilities receives new CVEs information and :ref:`min_full_scan_interval <vuln_det_min_full_scan_interval>` expires all packages, as well as the operating system, will be re-scanned.
Reducing the times that the `Full scans` are triggered improves the usage of the system resources and increase the performance avoiding repeat alerts of already notified vulnerabilities during a configurable time.

We have then three different types of scan:

- `Baseline`: This scan type will be triggered the first time after `Vulnerability Detector` is enabled. It performs a full scan for every single package installed as well as the operating system. As a result, the CVEs inventory will have the information of the vulnerabilities detected but no alerts will be generated.
- `Full scan`: In this scan type, every single package installed as well as the operating system are scanned. It runs only when the configured :ref:`min_full_scan_interval <vuln_det_min_full_scan_interval>` expires and the CVEs database is updated with new information. As a result, the newly detected vulnerabilities and the ones that no longer affect the agent will be alerted.
- `Partial scan`: Only new packages are scanned and the new vulnerabilities detected are alerted together with deleted or updated packages.

There are few considerations that arise from this behavior:

- The user can not trigger a `Full scan` manually. The only option is to disable and enable `Vulnerability Detector` to trigger the `Baseline` scan. For that purpose, a service restart is needed.
- The `partial scan` can be triggered with a manager restart and generate alerts for new packages, as well as alerts for removed packages.
- The new :ref:`min_full_scan_interval <vuln_det_min_full_scan_interval>` setting, will protect the manager performance from running too often `Full scans` in case of receiving many updates of vulnerabilities feeds.

Alerts generation
^^^^^^

- No alerts are generated for the results of a `Baseline` scan.
- Detection alerts are generated in both, `Partial scan` and `Full scan` when is detected that a vulnerability affects one of the packages scanned.
- Removal alerts are generated in both, `Partial scan` and `Full scan`, when is detected that a vulnerability is obsolete.

Check :doc:`Vulnerability detector settings<../../reference/ossec-conf/vuln-detector>` for more configuration details.

The following example diagram may be useful to understand all steps involved in the `vulnerability detector` workflow.

.. thumbnail:: ../../../images/manual/vuln-detector/vuln-detector-workflow.png
    :title: Vulnerability detector workflow
    :align: center
    :width: 100%
