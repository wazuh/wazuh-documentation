.. _amazon_use-cases_ec2:

EC2 Use cases
--------------

Amazon Elastic Compute Cloud (Amazon EC2) is a web service that provides resizable compute capacity in the cloud. It is designed to make web-scale cloud computing easier for developers.

Amazon EC2's simple web service interface allows you to obtain and configure capacity with minimal friction. It provides you a complete control of your computing resources and lets you run on Amazon's proven computing environment. Amazon EC2 reduces the time required to obtain and boot new server instances to minutes, allowing you to quickly scale capacity, both up and down, as your computing requirements change. Amazon EC2 changes the economics of computing by allowing you to pay only for capacity that you actually use. Amazon EC2 provides developers the tools to build failure resilient applications and isolate themselves from common failure scenarios.

To follow find some use cases when using some of the Wazuh rules built for EC2.

Run a new instance in EC2
+++++++++++++++++++++++++

When a user runs a new instance in EC2, an AWS event is generated. As per the diagram at the beginning of this section, the log message flows until the Wazuh agent gets the log file and sends it to the Wazuh manager. The latter analyzes the log file and finds that the log message generated by this event which matches the rule with id number 80301. Due to this match, an alert is generated and Kibana will show it as seen below:

+----------------------------------------------------------------------+
|**Definition of rule 80301**                                          |
+----------------------------------------------------------------------+
|::                                                                    |
|                                                                      |
|  <rule id="80301" level="2">                                         |
|      <if_sid>80300</if_sid>                                          |
|      <action>RunInstances</action>                                   |
|      <description>Amazon-ec2: Run instance</description>             |
|      <group>amazon,pci_dss_10.6.1,</group>                           |
|  </rule>                                                             |
+----------------------------------------------------------------------+
|    **Kibana will show this alert**                                   |
+----------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-1.png                         |
|    :align: center                                                    |
|    :width: 100%                                                      |
+----------------------------------------------------------------------+

When a user **without permissions** tries to run an instance, then the log message will match the ``rule id 80303`` and an alert will be generated as seen below:

+----------------------------------------------------------------------+
|**Definition of rule 80303**                                          |
+----------------------------------------------------------------------+
|::                                                                    |
|                                                                      |
|  <rule id="80301" level="2">                                         |
|      <if_sid>80301</if_sid>                                          |
|      <match>"errorCode":"Client.UnauthorizedOperation"</match>       |
|      <description>Amazon-ec2: Run instance unauthorized</description>|
|      <group>amazon,pci_dss_10.6.1,</group>                           |
|  </rule>                                                             |
+----------------------------------------------------------------------+
|    **Kibana will show this alert**                                   |
+----------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-2.png                         |
|    :align: center                                                    |
|    :width: 100%                                                      |
+----------------------------------------------------------------------+

Start instances in EC2
++++++++++++++++++++++

When one instance in EC2 is started, the log message will match the ``rule id 80305`` and an alert will be generated as shown below:

+----------------------------------------------------------------------+
|**Definition of rule 80305**                                          |
+----------------------------------------------------------------------+
|::                                                                    |
|                                                                      |
|  <rule id="80305" level="2">                                         |
|      <if_sid>80300</if_sid>                                          |
|      <action>StartInstances</action>                                 |
|      <description>Amazon-ec2: Instance started</description>         |
|      <group>amazon,pci_dss_10.6.1,</group>                           |
|  </rule>                                                             |
+----------------------------------------------------------------------+
|    **Kibana will show this alert**                                   |
+----------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-3.png                         |
|    :align: center                                                    |
|    :width: 100%                                                      |
+----------------------------------------------------------------------+

If one user **without permissions** to start instances tries to start one, the ``rule id 80306`` will apply and an alert will be generated as shown below:

+------------------------------------------------------------------------+
|**Definition of rule 80306**                                            |
+------------------------------------------------------------------------+
|::                                                                      |
|                                                                        |
|  <rule id="80306" level="5">                                           |
|      <if_sid>80305</if_sid>                                            |
|      <match>"errorCode":"Client.UnauthorizedOperation"</match>         |
|      <description>Amazon-ec2: Start instance unauthorized</description>|
|      <group>amazon,pci_dss_10.6.1,</group>                             |
|  </rule>                                                               |
+------------------------------------------------------------------------+
|    **Kibana will show this alert**                                     |
+------------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-4.png                           |
|    :align: center                                                      |
|    :width: 100%                                                        |
+------------------------------------------------------------------------+

Stop instances in EC2
+++++++++++++++++++++

When one instance in EC2 is stopped, the ``rule id 80308`` will apply and an alert will be generated as shown below:

+------------------------------------------------------------------------+
|**Definition of rule 80308**                                            |
+------------------------------------------------------------------------+
|::                                                                      |
|                                                                        |
|  <rule id="80308" level="2">                                           |
|      <if_sid>80300</if_sid>                                            |
|      <action>StopInstances</action>                                    |
|      <description>Amazon-ec2: Instance stopped</description>           |
|      <group>amazon,pci_dss_10.6.1,</group>                             |
|  </rule>                                                               |
+------------------------------------------------------------------------+
|    **Kibana will show this alert**                                     |
+------------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-5.png                           |
|    :align: center                                                      |
|    :width: 100%                                                        |
+------------------------------------------------------------------------+

If one user **without permissions** to start instances tries to start one, the ``rule id 80309`` will apply and an alert will be generated as shown below:

+------------------------------------------------------------------------+
|**Definition of rule 80309**                                            |
+------------------------------------------------------------------------+
|::                                                                      |
|                                                                        |
|  <rule id="80309" level="5">                                           |
|      <if_sid>80308</if_sid>                                            |
|      <action>StopInstances</action>                                    |
|      <match>"errorCode":"Client.UnauthorizedOperation"</match>         |
|      <description>Amazon-ec2: Stop instance unauthorized</description> |
|      <group>amazon,pci_dss_10.6.1,</group>                             |
|  </rule>                                                               |
+------------------------------------------------------------------------+
|    **Kibana will show this alert**                                     |
+------------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-6.png                           |
|    :align: center                                                      |
|    :width: 100%                                                        |
+------------------------------------------------------------------------+


Create Security Groups in EC2
+++++++++++++++++++++++++++++

When a new security group is created, the ``rule id 80404`` will match the log message generated by this event and an alert will be shown as follows:

+------------------------------------------------------------------------+
|**Definition of rule 80404**                                            |
+------------------------------------------------------------------------+
|::                                                                      |
|                                                                        |
|  <rule id="80404" level="2">                                           |
|      <if_sid>80300</if_sid>                                            |
|      <action>CreateSecurityGroup</action>                              |
|      <description>Amazon-ec2: Create Security Group</description>      |
|      <group>amazon,pci_dss_10.6.1,</group>                             |
|  </rule>                                                               |
+------------------------------------------------------------------------+
|    **Kibana will show this alert**                                     |
+------------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-7.png                           |
|    :align: center                                                      |
|    :width: 100%                                                        |
+------------------------------------------------------------------------+

Allocate new Elastic IP's address
+++++++++++++++++++++++++++++++++

If a new address Elastic IP's is allocated, then the ``rule id 80411`` will apply:

+------------------------------------------------------------------------+
|**Definition of rule 80411**                                            |
+------------------------------------------------------------------------+
|::                                                                      |
|                                                                        |
|  <rule id="80411" level="2">                                           |
|      <if_sid>80300</if_sid>                                            |
|      <action>AllocateAddress</action>                                  |
|      <description>Amazon-ec2: Allocate Address</description>           |
|      <group>amazon,</group>                                            |
|  </rule>                                                               |
+------------------------------------------------------------------------+
|    **Kibana will show this alert**                                     |
+------------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-8.png                           |
|    :align: center                                                      |
|    :width: 100%                                                        |
+------------------------------------------------------------------------+

Associate new Elastic IP's address
++++++++++++++++++++++++++++++++++

If one Elastic IP's addres is associated, then the ``rule id 80446`` will apply generating the corresponding alert:

+------------------------------------------------------------------------+
|**Definition of rule 80446**                                            |
+------------------------------------------------------------------------+
|::                                                                      |
|                                                                        |
|  <rule id="80446" level="2">                                           |
|      <if_sid>80300</if_sid>                                            |
|      <action>AssociateAddress</action>                                 |
|      <description>Amazon-ec2: Associate Address</description>          |
|      <group>amazon,pci_dss_10.6.1,</group>                             |
|  </rule>                                                               |
+------------------------------------------------------------------------+
|    **Kibana will show this alert**                                     |
+------------------------------------------------------------------------+
|.. thumbnail:: ../../images/aws/aws-ec2-9.png                           |
|    :align: center                                                      |
|    :width: 100%                                                        |
+------------------------------------------------------------------------+

The Kibana Dashboards will show:

+-------------------------------------------------------+------------------------------------------------------+
| Pie Chart                                             | Stacked Groups                                       |
+=======================================================+======================================================+
| .. thumbnail:: ../../images/aws/aws-ec2-pannels-1.png | .. thumbnail:: ../../images/aws/aws-ec2-pannels-2.png|
|    :align: center                                     |    :align: center                                    |
|    :width: 100%                                       |    :width: 100%                                      |
+-------------------------------------------------------+------------------------------------------------------+
