.. _puppet_module:

Wazuh Puppet module
==============================

ToDo

OSSEC Puppet module (tmp)
---------------------------

.. note:: This Puppet module has been authored by Nicolas Zin, and updated by Jonathan Gazeley and Michael Porter. Wazuh has forked it with the purpose of maintaining it. Thank you to the authors for the contribution.

Download and install OSSEC module from Puppet Forge: ::

   $ sudo puppet module install wazuh-ossec
   Notice: Preparing to install into /etc/puppet/modules ...
   Notice: Downloading from https://forgeapi.puppetlabs.com ...
   Notice: Installing -- do not interrupt ...
   /etc/puppet/modules
   └─┬ wazuh-ossec (v2.0.1)
     ├── jfryman-selinux (v0.2.5)
     ├── puppetlabs-apt (v2.2.0)
     ├── puppetlabs-concat (v1.2.4)
     ├── puppetlabs-stdlib (v4.9.0)
     └── stahnma-epel (v1.1.1)

This module installs and configures OSSEC HIDS agent and manager.

The manager is configured by installing the ``ossec::server`` class, and using optionally:

 - ``ossec::command``: to define active/response command (like ``firewall-drop.sh``).
 - ``ossec::activeresponse``: to link rules to active/response commands.
 - ``ossec::addlog``: to define additional log files to monitor.

Example
^^^^^^^
Here is an example of a manifest ``ossec.pp``:

OSSEC manager: ::


  node "server.yourhost.com" {
     class { 'ossec::server':
       mailserver_ip => 'localhost',
       ossec_emailto => ['user@mycompany.com'],
       use_mysql => true,
       mysql_hostname => '127.0.0.1',
       mysql_name => 'ossec',
       mysql_password => 'yourpassword',
       mysql_username  => 'ossec',
     }

     ossec::command { 'firewallblock':
       command_name       => 'firewall-drop',
       command_executable => 'firewall-drop.sh',
       command_expect     => 'srcip'
     }

     ossec::activeresponse { 'blockWebattack':
        command_name => 'firewall-drop',
        ar_level     => 9,
        ar_rules_id  => [31153,31151],
        ar_repeated_offenders => '30,60,120'
     }

     ossec::addlog { 'monitorLogFile':
       logfile => '/var/log/secure',
       logtype => 'syslog'
     }

    class { '::mysql::server':
      root_password           => 'yourpassword',
      remove_default_accounts => true,
    }

    mysql::db { 'ossec':
      user     => 'ossec',
      password => 'yourpassword',
      host     => 'localhost',
      grant    => ['ALL'],
      sql      => '/var/ossec/contrib/sqlschema/mysql.schema'
    }
  }

OSSEC agent: ::

   node "client.yourhost.com" {

   class { "ossec::client":
     ossec_server_ip => "192.168.209.166"
   }

   }

Reference
^^^^^^^^^

OSSEC manager class
"""""""""""""""""""

class ossec::server
 - ``$mailserver_ip``: SMTP mail server.
 - ``$ossec_emailfrom`` (default: ``ossec@${domain}``: Email "from".
 - ``$ossec_emailto``: Email "to". ``['user1@mycompany.com','user2@mycompany.com']``
 - ``$ossec_active_response`` (default: ``true``): Enable/disable active-response (both on manager and agent).
 - ``$ossec_global_host_information_level`` (default: 8): Alerting level for the events generated by the host change monitor (from 0 to 16).
 - ``$ossec_global_stat_level``: (default: 8): Alerting level for the events generated by the statistical analysis (from 0 to 16).
 - ``$ossec_email_alert_level``: (default: 7): It correspond to a threshold (from 0 to 156 to sort alert send by email. Some alerts circumvent this threshold (when they have ``alert_email`` option).
 - ``$ossec_emailnotification``: (default: yes): Whether to send email notifications.
 - ``$ossec_prefilter`` : (default: ``false``) Command to run to prevent prelinking from creating false positives. ``This option can potentially impact performance negatively. The configured command will be run for each and every file checked.``
 - ``$local_decoder_template``:  (default: ``ossec/local_decoder.xml.erb``)
 - ``$local_rules_template``:   (default: ``ossec/local_rules.xml.erb``)
 - ``$manage_repo`` (default: ``true``): Install Ossec through Wazuh repositories.
 - ``manage_epel_repo`` (default: ``true``): Install epel repo and inotify-tools
 - ``$manage_paths`` (default: ``[ {'path' => '/etc,/usr/bin,/usr/sbin', 'report_changes' => 'no', 'realtime' => 'no'}, {'path' => '/bin,/sbin', 'report_changes' => 'yes', 'realtime' => 'yes'} ]``): Follow the instructions bellow.
 - ``$ossec_white_list``: Allow white listing of IP addresses.
 - ``$manage_client_keys``: (default: ``true``): Manage client keys option.
 - ``ossec_auto_ignore``: (default: ``yes``): Specifies if syscheck will ignore files that change too often (after the third change)
 - ``use_mysql``: (default: ``false``). Set to ``true`` to enable database integration for alerts and other outputs.
 - ``mariadb``: (default: ``false``). Set to ``true`` to enable to use mariadb instead of mysql.
 - ``mysql_hostname``: MySQL hostname.
 - ``mysql_name``: MySQL Database name.
 - ``mysql_password``: MySQL password.
 - ``mysql_username``: MySQL username.
 - ``ossec_extra_rules_config``: To use it, after enabling the Wazuh ruleset (either manually or via the automated script), take a look at the changes made to the ossec.conf file. You will need to put these same changes into the "$ossec_extra_rules_config" array parameter when calling the ossec::server class.
 - ``ossec_email_maxperhour``: (default: ``12``): Global Configuration with a larger maximum emails per hour
 - ``ossec_email_idsname``: (default: ``undef``)



Consequently, if you add or remove any of the Wazuh rules later on, you'll need to ensure to add/remove the appropriate bits in the "$ossec_extra_rules_config" array parameter as well.

function ossec::email_alert
 - ``$alert_email``: Email to send to.
 - ``$alert_group``: (default: ``false``): Array of name of rules group.

.. note:: No email will be send below the global ``$ossec_email_alert_level``.

function ossec::command
 - ``$command_name``: Human readable name for ``ossec::activeresponse`` usage.
 - ``$command_executable``: Name of the executable. OSSEC comes preloaded with ``disable-account.sh``, ``host-deny.sh``, ``ipfw.sh``, ``pf.sh``, ``route-null.sh``, ``firewall-drop.sh``, ``ipfw_mac.sh``, ``ossec-tweeter.sh``, ``restart-ossec.sh``.
 - ``$command_expect`` (default: ``srcip``).
 - ``$timeout_allowed`` (default: ``true``).

function ossec::activeresponse
 - ``$command_name``.
 - ``$ar_location`` (default: ``local``): It can be set to ``local``,``server``,``defined-agent``,``all``.
 - ``$ar_level`` (default: 7): Can take values between 0 and 16.
 - ``$ar_rules_id`` (default: ``[]``): List of rules ID.
 - ``$ar_timeout`` (default: 300): Usually active reponse blocks for a certain amount of time.
 - ``$ar_repeated_offenders`` (default: empty): A comma separated list of increasing timeouts in minutes for repeat offenders. There can be a maximum of 5 entries.
function ossec::addlog
 - ``$log_name``.
 - ``$agent_log``: (default: ``false``)
 - ``$logfile`` /path/to/log/file.
 - ``$logtype`` (default: syslog): The OSSEC ``log_format`` of the file.

OSSEC agent class
"""""""""""""""""

 - ``$ossec_server_ip``: IP of the server.
 - ``$ossec_server_hostname``: Hostname of the server.
 - ``$ossec_active_response`` (default: ``true``): Allows active response on this host.
 - ``$ossec_emailnotification`` (default: ``yes``): Whether to send email notifications or not.
 - ``$ossec_prefilter`` : (default: ``false``) Command to run to prevent prelinking from creating false positives. ``This option can potentially impact performance negatively. The configured command will be run for each and every file checked.``
 - ``$selinux`` (default: ``false``): Whether to install a SELinux policy to allow rotation of OSSEC logs.
 - ``agent_name`` (default: ``$::hostname``)
 - ``agent_ip_address`` (default: ``$::ipaddress``)
 - ``$manage_repo`` (default: ``true``): Install Ossec through Wazuh repositories.
 - ``manage_epel_repo`` (default: ``true``): Install epel repo and inotify-tools
 - ``$ossec_scanpaths`` (default: ``[]``): Agents can be Linux or Windows for this reason don't have ``ossec_scanpaths`` by default.
 - ``$manage_client_keys``: (default: ``true``): Manage client keys option.
 - ``ar_repeated_offenders``: (default: empty) A comma separated list of increasing timeouts in minutes for repeat offenders. There can be a maximum of 5 entries.

function ossec::addlog
 - ``$log_name``.
 - ``$agent_log`` (default: ``false``)
 - ``$logfile`` /path/to/log/file.
 - ``$logtype`` (default: syslog): The OSSEC ``log_format`` of the file.

ossec_scanpaths configuration
"""""""""""""""""""""""""""""

Leaving this unconfigured will result in OSSEC using the module defaults. By default, it will monitor /etc, /usr/bin, /usr/sbin, /bin and /sbin on Ossec Server, with real time monitoring disabled and report_changes enabled.

To overwrite the defaults or add in new paths to scan, you can use hiera to overwrite the defaults.

To tell OSSEC to enable real time monitoring of the default paths:

ossec::server::ossec_scanpaths:
  - path: /etc
    report_changes: 'no'
    realtime: 'no'
  - path: /usr/bin
    report_changes: 'no'
    realtime: 'no'
  - path: /usr/sbin
    report_changes: 'no'
    realtime: 'no'
  - path: /bin
    report_changes: 'yes'
    realtime: 'yes'
  - path: /sbin
    report_changes: 'yes'
    realtime: 'yes'

**Note: Configuring the ossec_scanpaths variable will overwrite the defaults. i.e. if you want to add a new directory to monitor, you must also add the above default paths to be monitored.**
