.. Copyright (C) 2020 Wazuh, Inc.

.. _cloud_your_environment_accessing_cold_storage:

.. meta::
  :description: Learn about accessing your environment's cold storage

Cold storage
======================

Understanding storage
---------------------

You will be able to visualize on your WUI a certain size of data that matches your tier, this is named :ref:`hot storage <cloud_glossary_hot_storage>`. This data is optimized to perform searches, analysis and visualizations, and will be available as soon as Wazuh manager processes it and Elasticsearch indexes it. If the environment's data exceeds the tier, the oldest data will be rotated. Which means it will not appear on the WUI but will still be available for download.

Select the most convenient tier to fit the environment demands, it is possible to use this `estimation tool <https://wazuh.com/cloud/#pricing>`_ to do so. The tiers include:  100GB, 250GB, 500GB, 1TB, and custom 1TB+ environments.


If the environment's storage surpasses the tier, that data will still be accessible as :ref:`cold storage <cloud_glossary_cold_storage>` (*offline* data) for a year without size limits. By default, alerts are stored as cold storage within 10 to 30 minutes after they are processed. Besides, your environment configuration will get a daily backup and will be held for 30 days. You may download this data using the :ref:`Wazuh Cloud API<cloud_apis>`. A guide is provided to :ref:`learn how to access cold storage <cloud_your_environment_accessing_cold_storage>`.

As an example:

A user with a 100GB tier that is generating 10GB of alerts per day, will be able to search and visualize the alerts of the last 10 days in the Wazuh WUI (10GB/day x 10 days = 100GB). When those 100GB of data are exceeded, the oldest data is rotated (keeping 100GB of total data on the WUI), but will remain accessible as cold storage for a year.


Access
------
The cold storage is located in an AWS S3 bucket. Using the Wazuh Cloud API, you can generate a temporary AWS token that allows you to download your data using the Amazon S3 REST API.

Prior to describing the process of manually accessing cold storage, a script is provided on the `Automation of the access`_ section to easily extract it after receiving the AWS token. Take a look at the `Filename format`_ section to understand how your information is stored.

1. **Authentication**

:ref:`Generate your API key <cloud_apis_auth>`.

2. **Getting AWS token**

Use the ``/storage/token`` endpoint of the :cloud-api-ref:`Wazuh Cloud API <tag/storage>` to get the AWS token.


3. **Using your AWS credentials**

Use the AWS-CLI to download your cold storage.

Create a new profile with the credentials generated by the previous request. Edit ``~/.aws/credentials``:

.. code-block:: console
   
   [wazuh_cloud_storage]
   aws_access_key_id = 1
   aws_secret_access_key = 2
   aws_session_token = 3

Then, test your credentials:

.. code-block:: console
   
   $ aws --profile wazuh_cloud_storage --region <region> s3 ls cloud-cold-<region>/<cloud_id>/

Mind replacing ``<cloud_id>`` with the environment's Cloud ID and ``<region>`` with your region.

Available regions are:

* North Virginia: ``us-east-1``
  
* Ohio: ``us-east-2``

* London: ``eu-west-2``

* Frankfurt: ``eu-central-1``

* Singapore: ``ap-southeast-1``

This values should replace the subsequent uses of the ``<region>`` field.

Filename format
---------------

Cold storage files are stored according to the following format:

``wazuh-cloud-cold-<region>/<cloud_id>/<category>[/<subcategory>]/<year>/<month>/<day>``

And each file will have the following name:

``<cloud_id>_<category>[_<subcategory>]_<YYYYMMDDTHHmm>_<UniqueString>.<format>``

Where each of those fields have the following meaning:

- ``<region>``:  It is the region where the subscription is located.

- ``<cloud_id>``: Environment's Cloud ID.

- ``<category>``: Either "output" or "config".

- ``<subcategory>``: Only used by the output category, contains "alerts", "archives" or "firewall" files.
  
- ``<year>``: Year when the message was received.
  
- ``<month>``: Month when the message was received.
  
- ``<day>``: Day when the message was received.
  
- ``<YYYYMMDDTHHmm>``: Digits of the year, month, day, hour, and minute when the file was delivered. Hours are in 24-hour format and in UTC. A log file delivered at a specific time can contain records written at any point before that time.
  
- ``<UniqueString>``: The 16-character UniqueString component of the file name prevents overwriting files. It has no meaning, and log processing software should ignore it.
  
- ``<format>``: It is the encoding of the file. It could be either "json.gz", which is a JSON text file in compressed gzip format, or "tar.gz".



Automation of the access
------------------------

We  provide `an script <https://wazuh-cloud-tools.s3-us-west-1.amazonaws.com/examples/wcloud-cold-storage.py>`_ which downloads the data from S3 and auto refreshes the AWS session. This can be used as an example to learn how to automatize this process.

Example of use:

.. code-block::

   $ wcloud-cold-storage.py --subscription <cloud_id> --private_key /home/cloud/my_key --output_path /home/cloud/data --region <region> --start_date 2020-04-23 --end_date 2020-04-24

Mind replacing ``<cloud_id>`` with your Cloud ID, ``<region>`` with your region and fitting the rest of the arguments.
