.. Copyright (C) 2018 Wazuh, Inc.

.. _docker_containers_activity:

Monitoring containers activity
==============================

We use a wodle for monitoring events on `Docker containers <https://www.docker.com/resources/what-container>`_ such as starting, stopping or pausing.

Wodle requirements
^^^^^^^^^^^^^^^^^^

The correct functioning of the integration implemented in Python requires the presence of certain libraries as `docker library <https://pypi.org/project/docker/>`_. This library can be installed with ``pip install docker`` command.

Configuring wodle
^^^^^^^^^^^^^^^^^

It is necessary to have the option ``disabled`` with the value ``no`` in the ``ossec.conf`` and restart the Wazuh agent for using this capability. Below there is an example of configuration in ``ossec.conf``:

.. code-block:: xml

    <wodle name="docker-listener">
        <interval>10m</interval>
        <attempts>5</attempts>
        <run_on_start>no</run_on_start>
        <disabled>no</disabled>
    </wodle>

Use cases
^^^^^^^^^

This wodle monitor container events. When you interact with containers, alerts will be generated and reported to Wazuh manager.

Below, you can see some examples of alerts caused by containers activity.

Start a Docker container
------------------------

The command ``docker start apache``, which start a container called `apache`, generates the following alert:

.. code-block:: console

    {
    "timestamp": "2018-10-05T17:15:33.892+0200",
    "rule": {
        "level": 3,
        "description": "Container apache started",
        "id": "87903",
        "mail": false,
        "groups": [
        "docker"
        ]
    },
    "agent": {
        "id": "002",
        "name": "agent001",
        "ip": "192.168.122.19"
    },
    "manager": {
        "name": "localhost.localdomain"
    },
    "id": "1538752533.76076",
    "cluster": {
        "name": "wazuh",
        "node": "master"
    },
    "full_log": "{\"integration\": \"docker\", \"docker\": {\"status\": \"start\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"start\", \"Actor\": {\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": {\"image\": \"httpd\", \"name\": \"apache\"}}, \"time\": 1538752533, \"timeNano\": 1538752533877226210}}",
    "decoder": {
        "name": "json"
    },
    "data": {
        "integration": "docker",
        "docker": {
        "status": "start",
        "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
        "from": "httpd",
        "Type": "container",
        "Action": "start",
        "Actor": {
            "ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
            "Attributes": {
            "image": "httpd",
            "name": "apache"
            }
        },
        "time": "1538752533",
        "timeNano": "1538752533877226240.000000"
        }
    },
    "location": "Wazuh-Docker"
    }


Stop a Docker container
-----------------------

This alert is generated by using the command ``docker stop apache``:

.. code-block:: console

    {
    "timestamp": "2018-10-05T17:16:53.412+0200",
    "rule": {
        "level": 3,
        "description": "Container apache stopped",
        "id": "87904",
        "mail": false,
        "groups": [
        "docker"
        ]
    },
    "agent": {
        "id": "002",
        "name": "agent001",
        "ip": "192.168.122.19"
    },
    "manager": {
        "name": "localhost.localdomain"
    },
    "id": "1538752613.100231",
    "cluster": {
        "name": "wazuh",
        "node": "master"
    },
    "full_log": "{\"integration\": \"docker\", \"docker\": {\"status\": \"stop\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"stop\", \"Actor\": {\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": {\"image\": \"httpd\", \"name\": \"apache\"}}, \"time\": 1538752613, \"timeNano\": 1538752613407075872}}",
    "decoder": {
        "name": "json"
    },
    "data": {
        "integration": "docker",
        "docker": {
        "status": "stop",
        "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
        "from": "httpd",
        "Type": "container",
        "Action": "stop",
        "Actor": {
            "ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
            "Attributes": {
            "image": "httpd",
            "name": "apache"
            }
        },
        "time": "1538752613",
        "timeNano": "1538752613407075840.000000"
        }
    },
    "location": "Wazuh-Docker"
    }


Pause a Docker container
------------------------

With the command ``docker pause apache``:

.. code-block:: console

    {
    "timestamp": "2018-10-05T17:17:54.988+0200",
    "rule": {
        "level": 3,
        "description": "Container apache paused",
        "id": "87905",
        "mail": false,
        "groups": [
        "docker"
        ]
    },
    "agent": {
        "id": "002",
        "name": "agent001",
        "ip": "192.168.122.19"
    },
    "manager": {
        "name": "localhost.localdomain"
    },
    "id": "1538752674.104889",
    "cluster": {
        "name": "wazuh",
        "node": "master"
    },
    "full_log": "{\"integration\": \"docker\", \"docker\": {\"status\": \"pause\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"pause\", \"Actor\": {\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": {\"image\": \"httpd\", \"name\": \"apache\"}}, \"time\": 1538752674, \"timeNano\": 1538752674984734790}}",
    "decoder": {
        "name": "json"
    },
    "data": {
        "integration": "docker",
        "docker": {
        "status": "pause",
        "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
        "from": "httpd",
        "Type": "container",
        "Action": "pause",
        "Actor": {
            "ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
            "Attributes": {
            "image": "httpd",
            "name": "apache"
            }
        },
        "time": "1538752674",
        "timeNano": "1538752674984734720.000000"
        }
    },
    "location": "Wazuh-Docker"
    }


Unpause a Docker container
--------------------------

This is the alert for ``docker unpause apache`` command:

.. code-block:: console

    {
    "timestamp": "2018-10-05T17:18:35.373+0200",
    "rule": {
        "level": 3,
        "description": "Container apache unpaused",
        "id": "87906",
        "mail": false,
        "groups": [
        "docker"
        ]
    },
    "agent": {
        "id": "002",
        "name": "agent001",
        "ip": "192.168.122.19"
    },
    "manager": {
        "name": "localhost.localdomain"
    },
    "id": "1538752715.105822",
    "cluster": {
        "name": "wazuh",
        "node": "master"
    },
    "full_log": "{\"integration\": \"docker\", \"docker\": {\"status\": \"unpause\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"unpause\", \"Actor\": {\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": {\"image\": \"httpd\", \"name\": \"apache\"}}, \"time\": 1538752715, \"timeNano\": 1538752715369717277}}",
    "decoder": {
        "name": "json"
    },
    "data": {
        "integration": "docker",
        "docker": {
        "status": "unpause",
        "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
        "from": "httpd",
        "Type": "container",
        "Action": "unpause",
        "Actor": {
            "ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620",
            "Attributes": {
            "image": "httpd",
            "name": "apache"
            }
        },
        "time": "1538752715",
        "timeNano": "1538752715369717248.000000"
        }
    },
    "location": "Wazuh-Docker"
    }